<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.15.1/dist/phaser-arcade-physics.min.js"></script>
</head>
<body>

    <script>
var config = {
    type: Phaser.AUTO,
    width: 800,
    height: 600,
    parent: 'phaser-example',
    physics: {
        default: 'arcade',
        arcade: {
            debug: false
        }
    },
    scene: {
        preload: preload,
        create: create,
        update: update
    }
};

var game = new Phaser.Game(config);
        
var blue_units;
var blue_shots;
var red_units;
var red_shots;
        
var dummy = 0;
        
var money = 100;
var money_text;
var help_text;
        
var ui_options = [5, 4, 3]; // UI order
var ui_selection_image = null; // sprite for current selection
var ui_selection_unit = -1;
        
// TODO: ADD VALUES FOR DIFFERENT UNITS

function preload ()
{
    // basic
    this.load.image('bg_image', 'bg_image.png');
    this.load.image('tile', 'tile.png');
    
    // UI
    this.load.image('ui_holder', 'ui_holder.png');
    this.load.image('selection', 'selection.png');
    
    // units
    this.load.image('blue_soldier', 'blue_soldier.png');
    this.load.image('blue_cannon', 'blue_cannon.png');
    this.load.image('red_soldier', 'red_soldier.png');
    this.load.image('red_cannon', 'red_cannon.png');
    
    // buildings
    this.load.image('blue_base', 'blue_base.png');
    this.load.image('red_base', 'red_base.png');
    this.load.image('blue_turret', 'blue_turret.png');
    this.load.image('blue_barracks', 'blue_barracks.png');
    this.load.image('blue_wall', 'blue_wall.png');
    
    // shots
    this.load.image('shot', 'shot.png');
    this.load.image('big_shot', 'big_shot.png');
}

function create ()
{

    // add bg image
    this.add.image(400, 300, 'bg_image');
    
    // UI
    this.add.image(400, 600-20, 'ui_holder');
    
    // TODO: Make this better
    this.add.image(120+20, 600-20, 'blue_wall').setScale(0.5);
    this.add.image(160+20, 600-20, 'blue_barracks').setScale(0.5);
    this.add.image(200+20, 600-20, 'blue_turret').setScale(0.5);

    platforms = this.physics.add.staticGroup();
    // ground
    for (var i = 0; i < 20; i++) platforms.create(i*40 + 20, 600-20-40, 'tile');
    //for (var i = 0; i < 4; i++) platforms.create(i*40 + 20, 600-20-160, 'tile');
    //for (var i = 0; i < 4; i++) platforms.create(i*40 + 20, 600-20-400, 'tile');
    //for (var i = 0; i < 5; i++) platforms.create((i+9)*40 + 20, 600-20-80, 'tile');
    //for (var i = 0; i < 2; i++) platforms.create((i+11)*40 + 20, 600-20-120, 'tile');
    
    //for (var i = 0; i < 5; i++) platforms.create((i+3)*40 + 20, 600-20-240, 'tile');
    //for (var i = 0; i < 5; i++) platforms.create((i+15)*40 + 20, 600-20-240, 'tile');
    //for (var i = 0; i < 5; i++) platforms.create((i+15)*40 + 20, 600-20-440, 'tile');
    //platforms.create(7*40 + 20, 600-20-160, 'tile');
    //platforms.create(7*40 + 20, 600-20-200, 'tile');
    
    // unit physics groups
    blue_units = this.physics.add.group();
    blue_shots = this.physics.add.group();
    red_units = this.physics.add.group();
    red_shots = this.physics.add.group();
    
    
    this.physics.add.collider(blue_units, platforms);
    this.physics.add.collider(red_units, platforms);
    this.physics.add.collider(red_units, blue_units);
    
    this.physics.add.overlap(blue_units, red_shots, unit_hit, null, this);
    this.physics.add.overlap(red_units, blue_shots, unit_hit, null, this);
    this.physics.add.overlap(blue_shots, platforms, shot_hit_ground, null, this);
    this.physics.add.overlap(red_shots, platforms, shot_hit_ground, null, this);
    
    // GUI
    money_text = this.add.text(5, 600-25, 'Gold: ' + money, { fontFamily: 'Courier' }).setColor('#FFFFFF');
    money_text.setDepth(1);
    help_text = this.add.text(400, 600-25, 'Nothing selected', { fontFamily: 'Courier' }).setColor('#FFFFFF');
    help_text.setDepth(1);
    
    // TODO: Add tile based coordinates
    
    // create the blue and red base
    create_unit(2, 80, 600-120, 1, this);
    create_unit(2, 800 - 80, 600-120, 2, this);
    
    // create some test stuff
    
    // barracks
    //create_unit(4, 120+20, 600-100, 1, this);
    //create_unit(4, 120+60, 600-100, 1, this);
    //create_unit(4, 120+100, 600-100, 1, this);
    
    // turrets
    //create_unit(3, 120+100, 600-300, 1, this);
    //create_unit(3, 120+140, 600-300, 1, this);
    //create_unit(3, 120+140, 600-100, 1, this);
    
    // wall
    //create_unit(5, 120+180, 600-100, 1, this);
    
    // tank
    create_unit(6, 100, 600 - 100 , 1, this);
    create_unit(6, 120, 600 - 100 , 1, this);
    
    create_unit(6, 700, 600-100 , 2, this);
    
}

function update ()
{
    
    // UI logic
    
    // TODO: This is garbage
    if (game.input.mousePointer.isDown) {
        //console.log(ui_selection_image);
        var do_select = -1;
        var do_select_index = -1;
        if (game.input.mousePointer.y >= 600 - 40) {
            var index = Math.floor((game.input.mousePointer.x - 120) / 40)
            if (index >= 0 && index <= ui_options.length - 1) {
                do_select = ui_options[index];
                do_select_index = index;
            }
        }
        if (do_select == -1 && ui_selection_unit != -1) {
            if (ui_selection_image != null) {
                ui_selection_image.destroy();
            }
            ui_selection_unit = -1;
        } else if (do_select >= 0 && do_select != this.ui_selection_unit) {
            if (ui_selection_image != null) {
                ui_selection_image.destroy();
            }
            ui_selection_unit = do_select;
            ui_selection_image = this.add.image(120+20 + 40*do_select_index, 600-20, 'selection');
        }    
    }
    
    
    // Game logic
    cur_time = this.time.now;
    blue_units.children.each(function(unit) { run_unit_ai(unit, cur_time, this) }, this);
    red_units.children.each(function(unit) { run_unit_ai(unit, cur_time, this) }, this);
    // kill shots over the border
    blue_shots.children.each(function(shot) { check_shot_outside(shot) }, this);
    red_shots.children.each(function(shot) { check_shot_outside(shot) }, this);
    
    // mouse over for info   
    
    // attack
    //if (cur_time - dummy > 4000) {
    //    dummy = cur_time;
    //    //create_unit(1, 100, 500, 1, this);
    //    r = Math.random();
    //    if (r < 0.333) ypos = 2;
    //    else if (r < 0.666) ypos = 7;
    //    else ypos = 13;
    //    create_unit(1, 800-20, 600 - 20 - ypos*40 , 2, this);
    //}
}

function create_unit(type, xpos, ypos, player, th)
{
    // TODO: make use of some kind of map with properties, do not hard code stuff
    var graph_name;
    var group;
    if (player == 1) {
        group = blue_units;
        graph_name = 'blue_';
    } else if (player == 2) {
        group = red_units;
        graph_name = 'red_';
    } else {
        console.error('bad player type');
        return;
    }
    var health;
    var is_building = false;
    var width = 40;
    if (type == 1) {
        graph_name += 'soldier';
        health = 5;
    } else if (type == 2) {
        graph_name += 'base';
        health = 100;
        is_building = true;
        width = 80;
    } else if (type == 3) {
        graph_name += 'turret';
        health = 100;
        is_building = true;
    } else if (type == 4) {
        graph_name += 'barracks';
        health = 25;
        is_building = true;
    } else if (type == 5) {
        graph_name += 'wall';
        health = 250;
        is_building = true;
    } else if (type == 6) {
        graph_name += 'cannon';
        health = 85;
    } else {
        console.error('unknown unit type');
        return;
    }
    new_unit = group.create(xpos, ypos, graph_name);
    
    new_unit.x_player = player;
    new_unit.x_type = type;    
    new_unit.x_health = health;
    new_unit.x_max_health = health;
    new_unit.x_last_update = th.time.now; // TODO: Use input
    new_unit.x_is_building = is_building;
    new_unit.x_width = width;
    if (is_building) {
        new_unit.setImmovable(true);
        new_unit.x_health_bar = th.add.rectangle(xpos, ypos-width/2, width*0.75, 2, 0x00ff00);
        new_unit.x_health_bar.alpha = 0.25;
        new_unit.x_health_bar.setDepth(1);
    } else {
        new_unit.setGravity(0, 300);
        new_unit.setBounce(0.2);    
    }
}
        
function shoot(type, player, xpos, ypos, xvel, yvel, th) {
    var group;
    if (player == 1) {
        group = blue_shots;
    } else if (player == 2) {
        group = red_shots;
    } else {
        console.error('bad player type for shot');
        return;
    }
    // TODO: Add actual types
    if (type == 1) {
        new_shot = group.create(xpos, ypos, 'shot');   
    } else if (type == 2) {
        new_shot = group.create(xpos, ypos, 'big_shot');
    }
    new_shot.x_player = player;
    new_shot.x_type = type;
    new_shot.setVelocityX(xvel);
    new_shot.setVelocityY(yvel);
    new_shot.setGravity(0, 300);
}
        
        
function run_unit_ai(unit, cur_time, th)
{
    if (unit.x_player == 1) {
        if (unit.x > 600-40) unit.destroy();
    } else {
        if (unit.x < 40) unit.destroy();
    }
    dir_to_enemy = unit.x_player == 1 ? 1 : -1;
    // TODO: Implemente proper AI
    if (unit.x_type == 1) { // SOLDIER
        if (cur_time - unit.x_last_update > 500) {
            unit.x_last_update = cur_time;
            unit.setVelocityX(Math.random()*50*dir_to_enemy);
            if (Math.random() > 0.85) {
                unit.setVelocityY(-200);
            } 
            if (Math.random() > 0.5) {
                shoot(1, unit.x_player, unit.x, unit.y, dir_to_enemy*200, -50, th);
            } 
        }
    } else if (unit.x_type == 2) { // BASE
        // create an unit every 5 seconds
        if (cur_time - unit.x_last_update > 5000) {
            unit.x_last_update = cur_time;
            create_unit(1, unit.x, unit.y, unit.x_player, th);
            // Give money every 5 seconds
            update_money(25);
        }
    } else if (unit.x_type == 3) { // TURRET
        // shoot in random directions quickly
        if (cur_time - unit.x_last_update > 300) {
            unit.x_last_update = cur_time;
            a = Math.random()*3.14*0.3;
            velx = Math.cos(a)*400;
            vely = -Math.sin(a)*400;
            shoot(1, unit.x_player, unit.x, unit.y, velx, vely, th);
        }
    } else if (unit.x_type == 4) { // BARRACKS
        // create an unit every 5 seconds
        if (cur_time - unit.x_last_update > 5000) {
            unit.x_last_update = cur_time;
            create_unit(1, unit.x, unit.y, unit.x_player, th);
        }
    } else if (unit.x_type == 6) { // CANNON
        if (cur_time - unit.x_last_update > 2000) {
            unit.x_last_update = cur_time;
            unit.setVelocityX(Math.random()*10*dir_to_enemy);
            shoot(2, unit.x_player, unit.x, unit.y, dir_to_enemy*200, -200, th);
        }
    }

}
        
function unit_hit(unit, shot)
{
    // TODO: Bigger shots?
    update_unit_health(unit, -3);   
    destroy_shot(shot, this);
}
        
function shot_hit_ground(shot, tile)
{
    destroy_shot(shot, this)
}
        
function destroy_shot(shot, th)
{
    // Big shot explosion
    if (shot.x_type == 2) {
        for (i = 0; i < 10; i++) {
            velx = (Math.random() - 0.5)*200;
            vely = -(Math.random()+ 0.5)*200;
            shoot(1, shot.x_player, shot.x, shot.y - 5, velx, vely, th);    
        }
        
    }
    shot.destroy();
}
        
function update_unit_health(unit, amount)
{
    unit.x_health += amount;
    if (unit.x_health > unit.x_max_health) {
        unit.x_health = unit.x_max_health;
    }
    if (unit.x_is_building) {
        var fraction = unit.x_health / unit.x_max_health;
        var new_width = unit.x_width * 0.75 * fraction;
        if (fraction >= 0.5) {
            unit.x_health_bar.fillColor = '0x00ff00';
        } else if (fraction < 0.5 && fraction >= 0.25) {
            unit.x_health_bar.fillColor = '0xffff00';
        } else {
            unit.x_health_bar.fillColor = '0xff0000';
        }
        unit.x_health_bar.width = new_width;
    }
    if (unit.x_health <= 0) {   
        unit.destroy();
        if (unit.x_is_building) {
            unit.x_health_bar.destroy();
        }
    }
}
        
function check_shot_outside(shot)
{
    if (shot.x < 0 || shot.x > 800 || shot.y < 0 || shot.y > 600) {
        shot.destroy();
    }            
}
        
function update_money(amount)
{
    money += amount;
    if (money < 0) {
        money = 0;
    }
    money_text.setText('Gold: ' + money);
}

    </script>

</body>
</html>