<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.15.1/dist/phaser-arcade-physics.min.js"></script>
</head>
<body>

    <script>
var config = {
    type: Phaser.AUTO,
    width: 800,
    height: 600,
    parent: 'phaser-example',
    physics: {
        default: 'arcade',
        arcade: {
            debug: false
        }
    },
    scene: {
        preload: preload,
        create: create,
        update: update
    }
};

var game = new Phaser.Game(config);
        
var blue_units;
var blue_shots;
var red_units;
var red_shots;
        
var dummy = 0;

function preload ()
{
    // basic
    this.load.image('bg_image', 'bg_image.png');
    this.load.image('ui_holder', 'ui_holder.png');
    this.load.image('tile', 'tile.png');
    
    // units
    this.load.image('blue_soldier', 'blue_soldier.png');
    this.load.image('red_soldier', 'red_soldier.png');
    
    // buildings
    this.load.image('blue_base', 'blue_base.png');
    this.load.image('blue_turret', 'blue_turret.png');
    this.load.image('blue_barracks', 'blue_barracks.png');
    
    // shots
    this.load.image('shot', 'shot.png');
}

function create ()
{
    
    cursors = this.input.keyboard.createCursorKeys();

    // add bg image and UI holder image
    this.add.image(400, 300, 'bg_image');
    this.add.image(400, 600-20, 'ui_holder');

    platforms = this.physics.add.staticGroup();
    // ground
    for (var i = 0; i < 20; i++) platforms.create(i*40 + 20, 600-20-40, 'tile');
    for (var i = 0; i < 4; i++) platforms.create(i*40 + 20, 600-20-160, 'tile');
    for (var i = 0; i < 4; i++) platforms.create(i*40 + 20, 600-20-400, 'tile');
    for (var i = 0; i < 5; i++) platforms.create((i+9)*40 + 20, 600-20-80, 'tile');
    for (var i = 0; i < 2; i++) platforms.create((i+11)*40 + 20, 600-20-120, 'tile');
    
    for (var i = 0; i < 5; i++) platforms.create((i+3)*40 + 20, 600-20-240, 'tile');
    for (var i = 0; i < 5; i++) platforms.create((i+15)*40 + 20, 600-20-240, 'tile');
    for (var i = 0; i < 5; i++) platforms.create((i+15)*40 + 20, 600-20-440, 'tile');
    platforms.create(7*40 + 20, 600-20-160, 'tile');
    platforms.create(7*40 + 20, 600-20-200, 'tile');
    
    // unit physics groups
    blue_units = this.physics.add.group();
    blue_shots = this.physics.add.group();
    red_units = this.physics.add.group();
    red_shots = this.physics.add.group();
    
    
    this.physics.add.collider(blue_units, platforms);
    this.physics.add.collider(red_units, platforms);
    this.physics.add.collider(red_units, blue_units);
    
    this.physics.add.overlap(blue_units, red_shots, unit_hit, null, this);
    this.physics.add.overlap(red_units, blue_shots, unit_hit, null, this);
    this.physics.add.overlap(blue_shots, platforms, shot_hit_ground, null, this);
    this.physics.add.overlap(red_shots, platforms, shot_hit_ground, null, this);
    
    // TODO: Add tile based coordinates
    
    // create the blue base
    create_unit(2, 80, 600-120, 1, this);
    // create some test stuff
    create_unit(4, 120+20, 600-100, 1, this);
    create_unit(4, 120+60, 600-100, 1, this);
    create_unit(4, 120+100, 600-100, 1, this);
    
    create_unit(3, 120+100, 600-300, 1, this);
    create_unit(3, 120+140, 600-300, 1, this);
    create_unit(3, 120+140, 600-100, 1, this);
    
}

function update ()
{
    cur_time = this.time.now;
    blue_units.children.each(function(unit) { run_unit_ai(unit, cur_time, this) }, this);
    red_units.children.each(function(unit) { run_unit_ai(unit, cur_time, this) }, this);
    // kill shots over the border
    blue_shots.children.each(function(shot) { check_shot_outside(shot) }, this);
    red_shots.children.each(function(shot) { check_shot_outside(shot) }, this);
    
    // mouse over for info
    
    
    // attack
    if (cur_time - dummy > 1000) {
        dummy = cur_time;
        //create_unit(1, 100, 500, 1, this);
        r = Math.random();
        if (r < 0.333) ypos = 2;
        else if (r < 0.666) ypos = 7;
        else ypos = 13;
        create_unit(1, 800-20, 600 - 20 - ypos*40 , 2, this);
    }
}

function create_unit(type, xpos, ypos, player, th)
{
    // TODO: This is garbage still
    var graph_name;
    var group;
    if (player == 1) {
        group = blue_units;
        graph_name = 'blue_';
    } else if (player == 2) {
        group = red_units;
        graph_name = 'red_';
    } else {
        console.error('bad player type');
        return;
    }
    var health;
    var is_building = false;
    if (type == 1) {
        graph_name += 'soldier';
        health = 5;
    } else if (type == 2) {
        graph_name += 'base';
        health = 100;
        is_building = true;
    } else if (type == 3) {
        graph_name += 'turret';
        health = 100;
        is_building = true;
    } else if (type == 4) {
        graph_name += 'barracks';
        health = 25;
        is_building = true;
    } else {
        console.error('unknown unit type');
        return;
    }
    new_unit = group.create(xpos, ypos, graph_name);
    
    new_unit.x_player = player;
    new_unit.x_type = type;    
    new_unit.x_health = health;
    new_unit.x_last_update = th.time.now; // TODO: Use input
    if (is_building) {
        new_unit.setImmovable(true);
    } else {
        new_unit.setGravity(0, 300);
        new_unit.setBounce(0.2);    
    }
}
        
function shoot(type, player, xpos, ypos, xvel, yvel, th) {
    var group;
    if (player == 1) {
        group = blue_shots;
    } else if (player == 2) {
        group = red_shots;
    } else {
        console.error('bad player type');
        return;
    }
    // TODO: Add actual types
    new_shot = group.create(xpos, ypos, 'shot');
    new_shot.setVelocityX(xvel);
    new_shot.setVelocityY(yvel);
    new_shot.setGravity(0, 300);
}
        
        
function run_unit_ai(unit, cur_time, th)
{
    if (unit.x_player == 1) {
        if (unit.x > 600-40) unit.destroy();
    } else {
        if (unit.x < 40) unit.destroy();
    }
    // TODO: Implemente proper AI
    if (unit.x_type == 1) { // SOLDIER
        if (cur_time - unit.x_last_update > 500) {
            unit.x_last_update = cur_time;
            
            if (unit.x_player == 1) {
                dir = 1;
            } else {
                dir = -1;
            }
            unit.setVelocityX(Math.random()*50*dir);
            // jump every now and then
            if (Math.random() > 0.85) {
                unit.setVelocityY(-200);
            } 
            // shoot
            // TODO: select direction
            if (Math.random() > 0.5) {
                shoot(1, unit.x_player, unit.x, unit.y, dir*200, -50, th);
            } 
        }
    } else if (unit.x_type == 2) { // BASE
        // create an unit every 5 seconds
        if (cur_time - unit.x_last_update > 5000) {
            unit.x_last_update = cur_time;
            create_unit(1, unit.x, unit.y, unit.x_player, th);
        }
    } else if (unit.x_type == 3) { // TURRET
        // shoot in random directions quickly
        if (cur_time - unit.x_last_update > 300) {
            unit.x_last_update = cur_time;
            a = Math.random()*3.14*0.3;
            velx = Math.cos(a)*400;
            vely = -Math.sin(a)*400;
            shoot(1, unit.x_player, unit.x, unit.y, velx, vely, th);
        }
    } else if (unit.x_type == 4) { // BARRACKS
        // create an unit every 5 seconds
        if (cur_time - unit.x_last_update > 5000) {
            unit.x_last_update = cur_time;
            create_unit(1, unit.x, unit.y, unit.x_player, th);
        }
    }

}
        
function unit_hit(unit, shot)
{
    // TODO:
    unit.x_health -= 3;
    if (unit.x_health <= 0) {
        unit.destroy();
    }
    shot.destroy();
}
        
function shot_hit_ground(shot, tile)
{
    // TODO:
    shot.destroy();
}
        
function check_shot_outside(shot)
{
    if (shot.x < 0 || shot.x > 800 || shot.y < 0 || shot.y > 600) {
        shot.destroy();
    }            
}

    </script>

</body>
</html>